apt update
apt -y upgrade
apt install -y sudo parted htop screen bash-completion apt-transport-https openssh-server ca-certificates

APTSOURCES=$(cat <<EOF
deb https://deb.debian.org/debian/ bullseye main contrib non-free
deb-src https://deb.debian.org/debian/ bullseye main contrib non-free

deb https://deb.debian.org/debian/ bullseye-updates main contrib non-free
deb-src https://deb.debian.org/debian/ bullseye-updates main contrib non-free

deb https://deb.debian.org/debian-security bullseye-security main contrib
deb-src https://deb.debian.org/debian-security bullseye-security main contrib
EOF
)

echo -e "${APTSOURCES}" > /etc/apt/sources.list
apt update

exit
chroot /mnt /usr/bin/env DISK=$DISK bash --login

ln -s /proc/self/mounts /etc/mtab
apt install -y console-setup locales

dpkg-reconfigure locales tzdata keyboard-configuration console-setup

apt install -y dpkg-dev linux-headers-amd64 linux-image-amd64
apt install -y zfs-initramfs

echo REMAKE_INITRD=yes > /etc/dkms/zfs.conf

# UEFI
apt install dosfstools
ls -l /dev/disk/by-id/
DISK=/dev/disk/by-id/scsi-0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-0
DISK1=/dev/disk/by-id/scsi-0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-1
DISK2=/dev/disk/by-id/scsi-0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-2
echo -e $DISK
echo -e $DISK1
echo -e $DISK2

mkdosfs -F 32 -s 1 -n EFI ${DISK}-part2
mkdir /boot/efi
echo ${DISK}-part2 /boot/efi vfat defaults 0 0 >> /etc/fstab
mount /boot/efi

apt install -y grub-efi-amd64 shim-signed
apt remove -y --purge os-prober

passwd

nano /etc/systemd/system/zfs-import-bpool.service
	---
[Unit]
DefaultDependencies=no
Before=zfs-import-scan.service
Before=zfs-import-cache.service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/sbin/zpool import -N -o cachefile=none bpool
# Work-around to preserve zpool cache:
ExecStartPre=-/bin/mv /etc/zfs/zpool.cache /etc/zfs/preboot_zpool.cache
ExecStartPost=-/bin/mv /etc/zfs/preboot_zpool.cache /etc/zfs/zpool.cache

[Install]
WantedBy=zfs-import.target
	---

systemctl enable zfs-import-bpool.service

cp /usr/share/systemd/tmp.mount /etc/systemd/system/
systemctl enable tmp.mount

grub-probe /boot
update-initramfs -c -k all
nano /etc/default/grub
	---
	GRUB_CMDLINE_LINUX_DEFAULT="GRUB_TERMINAL=console"
	GRUB_CMDLINE_LINUX="root=ZFS=rpool/ROOT/debian net.ifnames=0 biosdevname=0"

	GRUB_SAVEDEFAULT=true
	GRUB_DEFAULT=saved
	---
mv /etc/network/interfaces.d/enp1s0 /etc/network/interfaces.d/eth0
	++ nano /etc/network/interfaces.d/eth0		# change interface name

update-grub
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=debian --recheck --no-floppy
    
>> if there is this error:
Installing for x86_64-efi platform.
grub-install: warning: Cannot set EFI variable Boot0004.
grub-install: warning: efivarfs_set_variable: writing to fd 6 failed: No space left on device.
grub-install: warning: _efi_set_variable_mode: ops->set_variable() failed: No space left on device.
grub-install: error: failed to register the EFI boot entry: No space left on device.
>> run:
rm /sys/firmware/efi/efivars/dump-type0-*

mkdir /etc/zfs/zfs-list.cache
touch /etc/zfs/zfs-list.cache/bpool
touch /etc/zfs/zfs-list.cache/rpool
ln -s /usr/lib/zfs-linux/zed.d/history_event-zfs-list-cacher.sh /etc/zfs/zed.d
zed -F &

# değişiklik görene kadar izle
watch -n1 cat /etc/zfs/zfs-list.cache/bpool
watch -n1 cat /etc/zfs/zfs-list.cache/rpool

fg		# foreground zed
Ctrl+C	# exit zed

sed -Ei "s|/mnt/?|/|" /etc/zfs/zfs-list.cache/*

zfs snapshot bpool/BOOT/debian@install
zfs snapshot rpool/ROOT/debian@install

<---	exit	# chroot exit

mount | grep -v zfs | tac | awk '/\/mnt/ {print $3}' | xargs -i{} umount -lf {}		# LiveCD environment to unmount all filesystems

zpool export -a
	# if fails	
	zpool import -f rpool
	exit

reboot







